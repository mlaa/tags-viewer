(function(i){i.fn.sheetrock=function(G){G=w(i.extend({},i.fn.sheetrock.options,G,e(this)));if(G){var F=new i.Deferred();if(G.sql&&i.isEmptyObject(G.columns)){s("Prefetching column labels.");var H={sql:"select * limit 1",target:false};h(i.extend({},G,H)).done(function(I){G.columns=t[G.key+G.gid]=C(I.table.cols);F.resolve()})}else{F.resolve()}F.done(function(){h(G).done(function(I){if(A(I)){G.dataHandler(I,G)}else{q(G.target,n,1);return s("Returned data failed validation.")}}).always(function(){if(G.loading){G.loading.hide()}if(G.userCallback){G.userCallback(G)}i.fn.sheetrock.working--})})}return this};var t={},j=0,n="sheetrockError",c="sheetrockLoaded",x="sheetrockRowOffset",h=function(F){if(F.loading){F.loading.show()}if(F.chunkSize&&F.target){F.sql+=" limit "+(F.chunkSize+1)+" offset "+F.offset;q(F.target,x,F.offset+F.chunkSize)}F.callback="sheetrock_"+j++;i.fn.sheetrock.working++;var G=m(F);return i.ajax({data:G,url:"https://spreadsheets.google.com/tq",dataType:"jsonp",cache:true,jsonp:false,jsonpCallback:F.callback})},A=function(F){if(l(F,"status")&&(F.status==="ok"||F.status==="warning")&&l(F,"table")){if(l(F,"warnings")){i.each(F.warnings,function(G,H){s(H)})}return true}else{if(l(F,"errors")){i.each(F.errors,function(H,G){s(G.message);s(G.detailed_message)})}return false}},f=function(I,G){s(I,G.debug);var H=(G.chunkSize)?Math.min(I.table.rows.length,G.chunkSize):I.table.rows.length,F=(!G.chunkSize||H<G.chunkSize)?1:0,K=(i.map(I.table.cols,r).length)?1:0,J=(G.labels&&G.labels.length===I.table.cols.length)?G.labels:i.map(I.table.cols,k);q(G.target,c,F);if(!G.offset&&!G.headersOff){if(K||!G.headers){G.target.append(G.rowHandler({num:0,cells:u(J)}))}}i.each(I.table.rows,function(N,O){if(l(O,"c")&&N<H){var M=v(G.offset+N+1+K-G.headers),L={num:M,cells:{}};if(M||!G.headersOff){i.each(O.c,function(Q,P){var R=(G.formatting)?o(P):false,S=(P&&l(P,"v"))?G.cellHandler(P.v):"";L.cells[J[Q]]=(R)?a(S,"span",R):S});G.target.append(G.rowHandler(L))}}})},w=function(F){F.key=d(F.url);F.gid=z(F.url);F.columns=t[F.key+F.gid]||F.columns;F.chunkSize=(F.target)?v(F.chunkSize):0;F.headers=v(F.headers);F.offset=(F.chunkSize)?b(F.target,x):0;F.loading=D(F.loading);if(!F.target&&F.dataHandler===f){return s("No element targeted or data handler provided.")}else{if(b(F.target,c)){return s("No more rows to load!")}else{if(b(F.target,n)){return s("A previous request for this resource failed.")}else{if(!F.url){return s("No spreadsheet URL provided.")}else{if(!F.key){return s("Could not find a key in the provided URL.")}else{if(!F.gid){return s("Could not find a gid in the provided URL.")}}}}}}s(F,F.debug);return F},m=function(F){var G={key:F.key,gid:F.gid,tqx:"responseHandler:"+F.callback};if(F.sql){G.tq=g(F.sql,F.columns)}return G},p=function(F){return F.toString().replace(/^ +/,"").replace(/ +$/,"")},v=function(F){return Math.max(0,parseInt(F,10)||0)},l=function(F,G){return y(F[G])},y=function(F){return(typeof F==="undefined")?false:true},s=function(G,F){F=!y(F)||(y(F)&&F);if(F&&window.console&&console.log){console.log(G)}return false},e=function(F){var G=(F.length)?F:false;return{target:G}},b=function(G,F){return(G.length)?i.data(G[0],F)||0:0},q=function(G,F,H){return(G.length)?i.data(G[0],F,H)||0:0},d=function(G){var F=new RegExp("key=([a-z0-9]{30,})&?","i");return(F.test(G))?G.match(F)[1]:false},z=function(F){var G=new RegExp("gid=([0-9]+)","i");return(G.test(F))?F.match(G)[1]:false},E=function(F){return(l(F,"label"))?F.label.replace(/\s/g,""):false},r=function(F){return E(F)||null},k=function(F){return E(F)||F.id},C=function(G){var F={};i.each(G,function(I,H){F[H.id]=k(H)});return F},g=function(G,F){i.each(F,function(H,I){G=G.replace(new RegExp("%"+I+"%","g"),H)});return G},D=function(F){return(F&&!(F instanceof jQuery))?i(F):F},u=function(F){var G={};i.each(F,function(H,I){G[I]=I});return G},o=function(F){return(F&&l(F,"p")&&l(F.p,"style"))?F.p.style:false},B=function(H){var I,G="",F=(H.num)?"td":"th";for(I in H.cells){if(l(H.cells,I)){G+=a(H.cells[I],F,"")}}return a(G,"tr","")},a=function(I,G,H){var F=(H)?' style="'+H+'"':"";return"<"+G+F+">"+I+"</"+G+">"};i.fn.sheetrock.options={url:"",headers:0,headersOff:false,labels:[],formatting:false,chunkSize:0,debug:false,sql:"",columns:{},rowHandler:B,cellHandler:p,dataHandler:f,userCallback:false,loading:false};i.fn.sheetrock.working=0})(jQuery);