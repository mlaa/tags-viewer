(function(p){p.fn.sheetrock=function(M){M=H(p.extend({},p.fn.sheetrock.options,M,B(this)));if(M){n=p.grep(n,f,true);n.push(p.fn.sheetrock.promise);p.fn.sheetrock.promise=p.fn.sheetrock.promise.pipe(function(){return g(M)}).pipe(function(){return x(M)})}return this};var u={},n=[],v=0,m="sheetrockError",A="sheetrockLoaded",K="sheetrockRowOffset",g=function(M){var N=u[M.key+M.gid]||M.columns;if(M.sql&&p.isEmptyObject(N)){c("Prefetching column labels.");return x(p.extend({},M,p.fn.sheetrock.prefetch))}else{return new p.Deferred().resolve()}},x=function(M){M.loading.show();if(M.chunkSize&&M.target){M.sql+=" limit "+(M.chunkSize+1)+" offset "+M.offset;q(M.target,K,M.offset+M.chunkSize)}M.callback="sheetrock_"+v++;p.fn.sheetrock.working++;var N={data:e(M),context:M,url:p.fn.sheetrock.server,dataType:"jsonp",cache:true,jsonp:false,jsonpCallback:M.callback};c(N,M.debug);return p.ajax(N).done(E).fail(d).always(s)},E=function(M){J(M,"warnings");J(M,"errors");c(M,this.debug);if(b(M,"status","table")&&b(M.table,"cols","rows")){this.dataHandler.call(l.call(this,M),M)}else{d.call(this,M)}},d=function(){q(this.target,m,1);c("Request failed.")},s=function(){this.loading.hide();this.userCallback(this);p.fn.sheetrock.working--},J=function(N,M){if(b(N,M)){p.each(N[M],function(P,O){if(b(O,"detailed_message")){c(O.detailed_message)}else{if(b(O,"message")){c(O.message)}}})}},l=function(N){var M=this;M.parsed={};M.parsed.last=(M.chunkSize)?Math.min(N.table.rows.length,M.chunkSize):N.table.rows.length;M.parsed.loaded=(!M.chunkSize||M.parsed.last<M.chunkSize)?1:0;M.parsed.header=(p.map(N.table.cols,F).length)?1:0;M.parsed.labels=(M.labels&&M.labels.length===N.table.cols.length)?M.labels:p.map(N.table.cols,L);q(M.target,A,M.parsed.loaded);return M},k=function(N){var M=this;if(!M.offset&&!M.headersOff){if(M.parsed.header||!M.headers){M.target.append(M.rowHandler({num:0,cells:I(M.parsed.labels)}))}}p.each(N.table.rows,function(Q,R){if(b(R,"c")&&Q<M.parsed.last){var P=j(M.offset+Q+1+M.parsed.header-M.headers),O={num:P,cells:{}};if(P||!M.headersOff){p.each(R.c,function(T,S){var U=(M.formatting)?D(S):false,V=(S&&b(S,"v"))?M.cellHandler(S.v):"";O.cells[M.parsed.labels[T]]=(U)?z(V,"span",U):V});M.target.append(M.rowHandler(O))}}})},t=function(M){var N={};p.each(M.table.cols,function(P,O){N[O.id]=L(O)});u[this.key+this.gid]=N},H=function(M){M.key=h(M.url);M.gid=y(M.url);M.chunkSize=(M.target)?j(M.chunkSize):0;M.headers=j(M.headers);M.offset=(M.chunkSize)?G(M.target,K):0;M.loading=r(M.loading);if(!M.target&&M.dataHandler===k){return c("No element targeted or data handler provided.")}else{if(G(M.target,A)){return c("No more rows to load!")}else{if(G(M.target,m)){return c("A previous request for this resource failed.")}else{if(!M.url){return c("No spreadsheet URL provided.")}else{if(!M.key){return c("Could not find a key in the provided URL.")}else{if(!M.gid){return c("Could not find a gid in the provided URL.")}}}}}}c(M,M.debug);return M},e=function(M){var N={key:M.key,gid:M.gid,tqx:"responseHandler:"+M.callback};if(M.sql){N.tq=o(M.sql,u[M.key+M.gid]||M.columns)}return N},a=function(M){return M.toString().replace(/^ +/,"").replace(/ +$/,"")},j=function(M){return Math.max(0,parseInt(M,10)||0)},b=function(N){for(var M=1;M<arguments.length;M++){if(!i(N[arguments[M]])){return false}}return true},i=function(M){return(typeof M==="undefined")?false:true},c=function(N,M){M=!i(M)||(i(M)&&M);if(M&&window.console&&console.log){console.log(N)}return false},B=function(M){var N=(M.length)?M:false;return{target:N}},G=function(N,M){return(N.length)?p.data(N[0],M)||0:0},q=function(N,M,O){return(N.length)?p.data(N[0],M,O)||0:0},h=function(N){var M=new RegExp("key=([a-z0-9]{30,})&?","i");return(M.test(N))?N.match(M)[1]:false},y=function(M){var N=new RegExp("gid=([0-9]+)","i");return(N.test(M))?M.match(N)[1]:false},C=function(M){return(b(M,"label"))?M.label.replace(/\s/g,""):false},F=function(M){return C(M)||null},L=function(M){return C(M)||M.id},f=function(M){return M.state()==="resolved"},o=function(N,M){p.each(M,function(O,P){N=N.replace(new RegExp("%"+P+"%","g"),O)});return N},r=function(M){return(M&&!(M instanceof jQuery))?p(M):M},I=function(M){var N={};p.each(M,function(O,P){N[P]=P});return N},D=function(M){return(M&&b(M,"p")&&b(M.p,"style"))?M.p.style:false},w=function(O){var P,N="",M=(O.num)?"td":"th";for(P in O.cells){if(b(O.cells,P)){N+=z(O.cells[P],M,"")}}return z(N,"tr","")},z=function(P,N,O){var M=(O)?' style="'+O+'"':"";return"<"+N+M+">"+P+"</"+N+">"};p.fn.sheetrock.options={url:"",headers:0,headersOff:false,labels:[],formatting:false,chunkSize:0,debug:false,sql:"",columns:{},rowHandler:w,cellHandler:a,dataHandler:k,userCallback:p.noop,loading:p()};p.fn.sheetrock.prefetch={sql:"select * limit 1",dataHandler:t,userCallback:p.noop,target:false};p.fn.sheetrock.server="https://spreadsheets.google.com/tq";p.fn.sheetrock.working=0;p.fn.sheetrock.promise=new p.Deferred().resolve()})(jQuery);