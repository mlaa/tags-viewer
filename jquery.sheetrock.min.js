(function(i){i.fn.sheetrock=function(y){y=r(i.extend({},i.fn.sheetrock.options,y),this);if(!y){return this}h(y)};var j=0,n="sheetrock-error",c="sheetrock-loaded",t="sheetrock-row-offset",h=function(y){if(l(y,"queued")){y=y.queued}if(l(y,"cached")){y.queued=y.cached}if(y.loading){y.loading.show()}if(y.chunkSize&&y.target){y.sql+=" limit "+(y.chunkSize+1)+" offset "+y.offset;i.data(y.target[0],t,y.offset+y.chunkSize)}y.callback="sheetrock_"+j++;i.fn.sheetrock.working++;var z=m(y);i.ajax({data:z,context:y,url:"https://spreadsheets.google.com/tq",dataType:"jsonp",cache:true,jsonp:false,jsonpCallback:y.callback,success:function(A){if(v(A)){this.dataHandler(A,this)}else{if(this.target){i.data(this.target[0],n,1)}}if(this.loading){this.loading.hide()}if(this.userCallback){this.userCallback(this)}i.fn.sheetrock.working--}});return this},v=function(y){if(l(y,"status")&&(y.status==="ok"||y.status==="warning")&&l(y,"table")){if(l(y,"warnings")){i.each(y.warnings,function(z,A){q(A)})}return true}else{if(l(y,"errors")){i.each(y.errors,function(A,z){q(z.message);q(z.detailed_message)})}return false}},f=function(B,z){if(z.debug){q(B)}var A=(z.chunkSize)?Math.min(B.table.rows.length,z.chunkSize):B.table.rows.length,y=(!z.chunkSize||A<z.chunkSize)?1:0,D=(i.map(B.table.cols,d).length)?1:0,C=(z.labels&&z.labels.length===B.table.cols.length)?z.labels:i.map(B.table.cols,k);if(z.target){i.data(z.target[0],c,y)}if(!z.offset&&!z.headersOff){if(D||!z.headers){z.target.append(z.rowHandler({num:0,cells:s(C)}))}}i.each(B.table.rows,function(G,H){if(l(H,"c")&&G<A){var F=Math.max(0,z.offset+G+1+D-z.headers),E={num:F,cells:{}};if(F||!z.headersOff){i.each(H.c,function(J,I){var K=(z.formatting)?o(I):false,L=(I&&l(I,"v"))?z.cellHandler(I.v):"";E.cells[C[J]]=(K)?a(L,"span",K):L});z.target.append(z.rowHandler(E))}}})},b=function(y){i.each(y.table.cols,function(A,z){i.fn.sheetrock.labels[z.id]=(l(z,"label"))?z.label.replace(/ /g,""):z.id});return true},r=function(A,B){A.key=e(A.url)||false;A.gid=u(A.url)||false;A.chunkSize=(B.length)?parseInt(A.chunkSize,10)||0:0;A.headers=parseInt(A.headers,10)||0;A.offset=(A.chunkSize)?parseInt(i.data(B[0],t),10)||0:0;A.target=(B.length)?B:false;var z=(B.length)?parseInt(i.data(B[0],c),10)||0:0,y=(B.length)?parseInt(i.data(B[0],n),10)||0:0;if(A.loading&&!(A.loading instanceof jQuery)){A.loading=i(A.loading)}if(!B.length&&A.dataHandler===f){q("Error: No element targeted or data handler provided.");return false}else{if(z){q("Halt: No more rows to load!");return false}else{if(y){q("Halt: A previous request for this resource failed.");return false}else{if(!A.url){q("Error: No spreadsheet URL provided.");return false}else{if(!A.key){q("Error: Could not find a key in the provided URL.");return false}else{if(!A.gid){q("Error: Could not find a gid in the provided URL.");return false}else{if(A.sql&&i.isEmptyObject(i.fn.sheetrock.labels)){q("Fetching column labels.");A=i.extend({},A,{sql:"",chunkSize:1,offset:0,loading:A.loading||false,target:false,dataHandler:b,userCallback:h,cached:A})}}}}}}}if(A.debug){q(A)}return A},m=function(y){var z={key:y.key,gid:y.gid,tqx:"responseHandler:"+y.callback};if(y.sql){z.tq=g(y.sql)}return z},p=function(y){return y.toString().replace(/^ +/,"").replace(/ +$/,"")},l=function(y,z){return(typeof y[z]==="undefined")?false:true},q=function(y){if(window.console&&console.log){console.log(y)}},e=function(z){var y=new RegExp("key=([a-z0-9]{30,})&?","i");return(y.test(z))?z.match(y)[1]:false},u=function(y){var z=new RegExp("gid=([0-9]+)","i");return(z.test(y))?y.match(z)[1]:false},d=function(y){return x(y)||null},k=function(y){return x(y)||y.id},x=function(y){return(l(y,"label"))?y.label.replace(/\s/g,""):false},g=function(y){i.each(i.fn.sheetrock.labels,function(z,A){y=y.replace(new RegExp("%"+A+"%","g"),z)});return y},s=function(y){var z={};i.each(y,function(A,B){z[B]=B});return z},o=function(y){return(y&&l(y,"p")&&l(y.p,"style"))?y.p.style:false},w=function(A){var B,z="",y=(A.num)?"td":"th";for(B in A.cells){z+=a(A.cells[B],y,"")}return a(z,"tr","")},a=function(B,z,A){var y=(A)?' style="'+A+'"':"";return"<"+z+y+">"+B+"</"+z+">"};i.fn.sheetrock.options={url:"",headers:0,headersOff:false,labels:[],formatting:false,chunkSize:0,debug:false,sql:"",rowHandler:w,cellHandler:p,dataHandler:f,userCallback:false,loading:false};i.fn.sheetrock.labels={};i.fn.sheetrock.working=0})(jQuery);