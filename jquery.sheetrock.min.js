(function(a){a.fn.sheetrock=function(a,b){return a.target=this.length?this:!1,a=t(a),a&&(y(b)&&null!==b?i(a,b):h(a)),this};var b={},c=[],d=0,e="sheetrockError",f="sheetrockLoaded",g="sheetrockRowOffset",h=function(b){c=a.grep(c,H,!0),c.push(a.fn.sheetrock.promise),a.fn.sheetrock.promise=a.fn.sheetrock.promise.pipe(function(){return j(b)}).pipe(function(){return k(b)})},i=function(a,b){l(a),m.call(a,b),o.call(a)},j=function(b){var c={sql:"select * limit 1",dataHandler:s,userCallback:a.noop,target:!1};return-1!==b.sql.indexOf("%")&&a.isEmptyObject(b.columns)?(z("Prefetching column labels."),k(a.extend({},b,c))):(new a.Deferred).resolve()},k=function(b){l(b),b.chunkSize&&b.target&&(b.sql+=" limit "+(b.chunkSize+1)+" offset "+b.offset,B(b.target,g,b.offset+b.chunkSize)),b.callback="sheetrock_"+d++;var c={data:u(b),context:b,url:a.fn.sheetrock.server,dataType:"jsonp",cache:!0,jsonp:!1,jsonpCallback:b.callback};return z(c,b.debug),a.ajax(c).done(m).fail(n).always(o)},l=function(b){b.loading.show(),a.fn.sheetrock.working++},m=function(a){p(a,"warnings"),p(a,"errors"),z(a,this.debug),x(a,"status","table")&&x(a.table,"cols","rows")?this.dataHandler.call(q.call(this,a),a):n.call(this,a)},n=function(){B(this.target,e,1),z("Request failed.")},o=function(){this.loading.hide(),this.userCallback(this),a.fn.sheetrock.working--},p=function(b,c){x(b,c)&&a.each(b[c],function(a,b){x(b,"detailed_message")?z(b.detailed_message):x(b,"message")&&z(b.message)})},q=function(b){var c=this;return c.parsed={},c.parsed.last=c.chunkSize?Math.min(b.table.rows.length,c.chunkSize):b.table.rows.length,c.parsed.loaded=!c.chunkSize||c.parsed.last<c.chunkSize?1:0,c.parsed.header=a.map(b.table.cols,F).length?1:0,c.parsed.labels=c.labels&&c.labels.length===b.table.cols.length?c.labels:a.map(b.table.cols,G),B(c.target,f,c.parsed.loaded),c},r=function(b){var c=this;c.offset||c.headersOff||(c.parsed.header||!c.headers)&&c.target.append(c.rowHandler({num:0,cells:K(c.parsed.labels)})),a.each(b.table.rows,function(b,d){if(x(d,"c")&&c.parsed.last>b){var e=w(c.offset+b+1+c.parsed.header-c.headers),f={num:e,cells:{}};(e||!c.headersOff)&&(a.each(d.c,function(a,b){var d=c.formatting?L(b):!1,e=b&&x(b,"v")?c.cellHandler(b.v):"";f.cells[c.parsed.labels[a]]=d?N(e,"span",d):e}),c.target.append(c.rowHandler(f)))}})},s=function(c){var d={};a.each(c.table.cols,function(a,b){d[b.id]=G(b)}),b[this.key+this.gid]=d},t=function(c){return c=a.extend({},a.fn.sheetrock.options,c),c.key=C(c.url),c.gid=D(c.url),c.chunkSize=c.target?w(c.chunkSize):0,c.headers=w(c.headers),c.columns=b[c.key+c.gid]||c.columns||{},c.offset=c.chunkSize?A(c.target,g):0,c.loading=J(c.loading),c.target||c.dataHandler!==r?A(c.target,f)?z("No more rows to load!"):A(c.target,e)?z("A previous request for this resource failed."):c.url?c.key?c.gid?(z(c,c.debug),c):z("Could not find a gid in the provided URL."):z("Could not find a key in the provided URL."):z("No spreadsheet URL provided."):z("No element targeted or data handler provided.")},u=function(a){var c={key:a.key,gid:a.gid,tqx:"responseHandler:"+a.callback};return a.sql&&(c.tq=I(a.sql,b[a.key+a.gid]||a.columns)),c},v=function(a){return(""+a).replace(/^ +/,"").replace(/ +$/,"")},w=function(a){return Math.max(0,parseInt(a,10)||0)},x=function(a){for(var b=1;arguments.length>b;b++)if(!y(a[arguments[b]]))return!1;return!0},y=function(a){return a===void 0?!1:!0},z=function(a,b){return b=!y(b)||y(b)&&b,b&&window.console&&console.log&&console.log(a),!1},A=function(b,c){return b.length?a.data(b[0],c)||0:0},B=function(b,c,d){return b.length?a.data(b[0],c,d)||0:0},C=function(a){var b=RegExp("key=([a-z0-9-]{30,})&?","i");return b.test(a)?a.match(b)[1]:!1},D=function(a){var b=RegExp("gid=([0-9]+)","i");return b.test(a)?a.match(b)[1]:!1},E=function(a){return x(a,"label")?a.label.replace(/\s/g,""):!1},F=function(a){return E(a)||null},G=function(a){return E(a)||a.id},H=function(a){return"resolved"===a.state()},I=function(b,c){return a.each(c,function(a,c){b=b.replace(RegExp("%"+c+"%","g"),a)}),b},J=function(b){return!b||b instanceof jQuery?b:a(b)},K=function(b){var c={};return a.each(b,function(a,b){c[b]=b}),c},L=function(a){return a&&x(a,"p")&&x(a.p,"style")?a.p.style:!1},M=function(a){var b,c="",d=a.num?"td":"th";for(b in a.cells)x(a.cells,b)&&(c+=N(a.cells[b],d,""));return N(c,"tr","")},N=function(a,b,c){var d=c?' style="'+c+'"':"";return"<"+b+d+">"+a+"</"+b+">"};a.fn.sheetrock.options={url:"",sql:"",chunkSize:0,columns:{},labels:[],rowHandler:M,cellHandler:v,dataHandler:r,userCallback:a.noop,loading:a(),debug:!1,headers:0,headersOff:!1,formatting:!1},a.fn.sheetrock.server="https://spreadsheets.google.com/tq",a.fn.sheetrock.working=0,a.fn.sheetrock.promise=(new a.Deferred).resolve()})(jQuery);
