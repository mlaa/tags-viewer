(function(i){i.fn.sheetrock=function(K){K=x(i.extend({},i.fn.sheetrock.options,K,e(this)));if(K){var J=new i.Deferred(),L={sql:"select * limit 1",dataHandler:D,userCallback:false,target:false};if(K.sql&&i.isEmptyObject(K.columns)){t("Prefetching column labels.");h(i.extend({},K,L)).always(J.resolve)}else{J.resolve()}J.done(function(){h(K)})}return this};var u={},j=0,o="sheetrockError",c="sheetrockLoaded",y="sheetrockRowOffset",h=function(J){if(J.loading){J.loading.show()}if(J.chunkSize&&J.target){J.sql+=" limit "+(J.chunkSize+1)+" offset "+J.offset;r(J.target,y,J.offset+J.chunkSize)}J.callback="sheetrock_"+j++;i.fn.sheetrock.working++;var K={data:n(J),context:J,url:"https://spreadsheets.google.com/tq",dataType:"jsonp",cache:true,jsonp:false,jsonpCallback:J.callback};t(K,J.debug);return i.ajax(K).done(B).fail(F).always(H)},B=function(J){I(J,"warnings");I(J,"errors");if(m(J,"status","table")&&m(J.table,"cols","rows")){this.dataHandler.call(k.call(this,J),J)}else{F.call(this,J)}},F=function(J){r(this.target,o,1);t("Request failed.");t(J,this.debug)},H=function(){if(this.loading){this.loading.hide()}if(this.userCallback){this.userCallback(this)}i.fn.sheetrock.working--},I=function(K,J){if(m(K,J)){i.each(K[J],function(M,L){if(m(L,"detailed_message")){t(L.detailed_message)}else{if(m(L,"message")){t(L.message)}}})}},k=function(K){var J=this;J.parsed={};J.parsed.last=(J.chunkSize)?Math.min(K.table.rows.length,J.chunkSize):K.table.rows.length;J.parsed.loaded=(!J.chunkSize||J.parsed.last<J.chunkSize)?1:0;J.parsed.header=(i.map(K.table.cols,s).length)?1:0;J.parsed.labels=(J.labels&&J.labels.length===K.table.cols.length)?J.labels:i.map(K.table.cols,l);r(J.target,c,J.parsed.loaded);return J},f=function(K){var J=this;t(K,J.debug);if(!J.offset&&!J.headersOff){if(J.parsed.header||!J.headers){J.target.append(J.rowHandler({num:0,cells:v(J.parsed.labels)}))}}i.each(K.table.rows,function(N,O){if(m(O,"c")&&N<J.parsed.last){var M=w(J.offset+N+1+J.parsed.header-J.headers),L={num:M,cells:{}};if(M||!J.headersOff){i.each(O.c,function(Q,P){var R=(J.formatting)?p(P):false,S=(P&&m(P,"v"))?J.cellHandler(P.v):"";L.cells[J.parsed.labels[Q]]=(R)?a(S,"span",R):S});J.target.append(J.rowHandler(L))}}})},D=function(J){var K={};i.each(J.table.cols,function(M,L){K[L.id]=l(L)});u[this.key+this.gid]=K},x=function(J){J.key=d(J.url);J.gid=A(J.url);J.columns=u[J.key+J.gid]||J.columns;J.chunkSize=(J.target)?w(J.chunkSize):0;J.headers=w(J.headers);J.offset=(J.chunkSize)?b(J.target,y):0;J.loading=E(J.loading);if(!J.target&&J.dataHandler===f){return t("No element targeted or data handler provided.")}else{if(b(J.target,c)){return t("No more rows to load!")}else{if(b(J.target,o)){return t("A previous request for this resource failed.")}else{if(!J.url){return t("No spreadsheet URL provided.")}else{if(!J.key){return t("Could not find a key in the provided URL.")}else{if(!J.gid){return t("Could not find a gid in the provided URL.")}}}}}}t(J,J.debug);return J},n=function(J){var K={key:J.key,gid:J.gid,tqx:"responseHandler:"+J.callback};if(J.sql){K.tq=g(J.sql,u[J.key+J.gid]||J.columns)}return K},q=function(J){return J.toString().replace(/^ +/,"").replace(/ +$/,"")},w=function(J){return Math.max(0,parseInt(J,10)||0)},m=function(K){for(var J=1;J<arguments.length;J++){if(!z(K[arguments[J]])){return false}}return true},z=function(J){return(typeof J==="undefined")?false:true},t=function(K,J){J=!z(J)||(z(J)&&J);if(J&&window.console&&console.log){console.log(K)}return false},e=function(J){var K=(J.length)?J:false;return{target:K}},b=function(K,J){return(K.length)?i.data(K[0],J)||0:0},r=function(K,J,L){return(K.length)?i.data(K[0],J,L)||0:0},d=function(K){var J=new RegExp("key=([a-z0-9]{30,})&?","i");return(J.test(K))?K.match(J)[1]:false},A=function(J){var K=new RegExp("gid=([0-9]+)","i");return(K.test(J))?J.match(K)[1]:false},G=function(J){return(m(J,"label"))?J.label.replace(/\s/g,""):false},s=function(J){return G(J)||null},l=function(J){return G(J)||J.id},g=function(K,J){i.each(J,function(L,M){K=K.replace(new RegExp("%"+M+"%","g"),L)});return K},E=function(J){return(J&&!(J instanceof jQuery))?i(J):J},v=function(J){var K={};i.each(J,function(L,M){K[M]=M});return K},p=function(J){return(J&&m(J,"p")&&m(J.p,"style"))?J.p.style:false},C=function(L){var M,K="",J=(L.num)?"td":"th";for(M in L.cells){if(m(L.cells,M)){K+=a(L.cells[M],J,"")}}return a(K,"tr","")},a=function(M,K,L){var J=(L)?' style="'+L+'"':"";return"<"+K+J+">"+M+"</"+K+">"};i.fn.sheetrock.options={url:"",headers:0,headersOff:false,labels:[],formatting:false,chunkSize:0,debug:false,sql:"",columns:{},rowHandler:C,cellHandler:q,dataHandler:f,userCallback:false,loading:false};i.fn.sheetrock.working=0})(jQuery);